<!DOCTYPE html>
<meta charset="utf-8">
<style>
    .states {
        fill-opacity: 1;
    }
    /*Tooltip style*/
    div.tooltip {   
     	position: absolute;           
    	text-align: center;           
    	width: 150px;                  
    	height: 50px;                 
    	padding: 2px;             
    	font: 11px sans-serif;        
    	background:white;   
    	border: 0px;      
    	border-radius: 5px;           
    	pointer-events: none;         
    }
</style>
<head>
    <title>COVID-19 Cases in the US</title>
    <!-- Load d3.v5.js -->
    <script src="https://d3js.org/d3.v5.min.js"></script>
    <script src="https://unpkg.com/topojson@3"></script>
    <script src="http://code.jquery.com/jquery-1.11.3.min.js"></script>

</head>

<body>
<!-- Create an element where the map will take place -->

<svg id="my_dataviz">
</svg>

<div id = "page1">
    <div id = "slider">
    </div>
</div>
<div id = "page2" style = "display:none">
    elements for page 2
</div>
<div id = "page3" style = "display:none">
    elements for page 3
</div>

<div>
    <div>
        <button id = "backward">Prev</button>
    </div>
    <div>
        <button id = "forward">Next</button>
    </div>
</div>

<script>

    //overall data and setting
    var usmap = d3.json("https://unpkg.com/us-atlas@1/us/10m.json");
    var data = d3.csv("../data/time_series_covid19_confirmed_US.csv");

    var width = 1000;
    var height = 750;
    var svg = d3.select("#my_dataviz").attr("width", width).attr("height", height)

    //map projection
    var projection = d3.geoAlbersUsa()
        .translate([480, 300]).scale(1280)
    var path = d3.geoPath()

    // Append Div for tooltip to SVG
    var div = d3.select("body")
		    .append("div")   
            .attr("id","tool-tip")
    		.attr("class", "tooltip")               
    		.style("opacity", 0);
        p1 = div.append("p")
        p2 = div.append("p")

    //update function for year
    var startDate = new Date("01/22/2020")

Promise.all([usmap, data]).then(function (values) {
    //read data and topojson file    
    var map = values[0];
    var covid = values[1];
    var stateFeatures = topojson.feature(map, map.objects.states).features;
    var countyFeatures = topojson.feature(map, map.objects.counties).features;

    console.log(map)
    console.log(countyFeatures)
    console.log(covid)


//settings for page 1************************************
    //slide bar location
    var slider = d3.select("#slider")
    //slide bar setting
    slider.append("input")
        .attr("type", "range")
        .attr("min", 0)
        .attr("max", 184) //col range
        .attr("step","1")
        .attr("id", "date")
        .attr("value", 184) //default value
        .on("input", function input() {
            update();
        }
        ); 




    function update(drawCircle) {
        svg.select("#circle-group").remove()

        var slider_col = document.getElementById("date").value;
        console.log(slider_col)
        var newDate = new Date(startDate.getTime() + slider_col*864E5);
        //console.log(newDate)
        var curDate = (newDate.getMonth()+1).toString() + "/" + newDate.getDate().toString() + "/20"
        //console.log(curDate)

        //console.log(covid[curDate])
        //console.log(covid["7/22/20"])
        var circles = svg
            .append("g")
            .attr("id","circle-group")
            .selectAll("circle")
        var join = circles.data(covid)
        var enter = join.enter()
        var exit = join.exit()
        
        //console.log(join)
        //console.log(enter)

        enter.append("circle")
            .filter(function(d) {
                return (projection([d.Long_, d.Lat])!==null && d[curDate]!=0)
                })
            .attr("cx", function(d) {return projection([d.Long_, d.Lat])[0];})
            .attr("cy", function(d) {return projection([d.Long_, d.Lat])[1];})
            .attr("r", function(d) {
                //console.log(d[curDate])
                return d[curDate]/10000})
            .style("fill", "blue")
            .attr("stroke", "blue")
            .attr("stroke-width", 3)
            .attr("fill-opacity", .4)
            .on("mouseover", function(d,i){
                //tooltip
                div.transition()        
      	            .duration(200)      
                    .style("opacity", .9);      
                p1.text(d["Admin2"]+", "+d["Province_State"])
                p2.text("Total Confirmed Case: "+d[curDate])
                div.style("left", (d3.event.pageX) + "px")     
                    .style("top", (d3.event.pageY - 28) + "px");
                //console.log(div)
            })
            .on("mouseout", function(d,i){
                div.transition()
                    .duration(500)
                    .style("opacity", 0);
            })
        exit.remove();
    }   

    function drawPage1() {
        //draw map
        svg.append("g")
            .selectAll("path")
            .data(countyFeatures)
            .enter()
            .append("path")
            .attr("fill", "#ccc")
            .attr("stroke", "white")
            .attr("d",path)
            .on("mouseover", function(d,i) {
                var currentState = this;
                d3.select(this).style("fill-opacity", 0.5);
            })
            .on("mouseout", function(d,i) {
                var currentState = this;
                d3.select(this).style("fill-opacity", 1)
            })
        svg.append("g") 
            .selectAll("path")
            .data(stateFeatures)
            .enter()
            .append("path")
            .attr("stroke", "red")
            .attr("fill", "none")
            .attr("d",path)
        
        update();
    
    }

    drawPage1();


//************ Draw Page 2***************
    covidByState = d3.nest()
        .key(function (d) {return d.Province_State;})
        //.rollup(function (v) {return d3.sum(v, function(d) {return d})})
        .entries(covid)

    console.log(covidByState)

    function drawPage2() {
        
    }

//****************************************
    //scene change
    var counter = 1

    $("#backward").click(function (){
		counter = counter - 1;
		if(counter < 1){
			counter = 3;
		}
        //hide or show elements for different pages
        var x = document.getElementById("page1");
        var y = document.getElementById("page2");
        var z = document.getElementById("page3");
        x.style.display = "none";
        y.style.display = "none";
        z.style.display = "none";
        d3.select("#my_dataviz").selectAll("*").remove();
        switch(counter) {
            case 1: 
                x.style.display = "block";
                drawPage1();
                break;
            case 2: 
                y.style.display = "block";
                break;
            case 3: z.style.display = "block"
        }
           
		//update svg below
        console.log(counter)
		});

	$("#forward").click(function (){
		counter = counter + 1;
		if(counter > 3){
			counter = 1;
		}
        //hide or show elements for different pages
        var x = document.getElementById("page1");
        var y = document.getElementById("page2");
        var z = document.getElementById("page3");
        d3.select("#my_dataviz").selectAll("*").remove();
        x.style.display = "none";
        y.style.display = "none";
        z.style.display = "none" 
        switch(counter) {
            case 1: 
                x.style.display = "block";
                drawPage1();
                break;
            case 2: 
                y.style.display = "block";
                break;
            case 3: z.style.display = "block"
        }
		//update svg below
        console.log(counter)
	});


});


  
</script>
</body>