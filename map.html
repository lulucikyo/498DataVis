<!DOCTYPE html>
<meta charset="utf-8">
<style>
    .states {
        fill-opacity: 1;
    }
    /*Tooltip style*/
    div.tooltip {   
     	position: absolute;           
    	text-align: center;           
    	width: 150px;                  
    	height: 50px;                 
    	padding: 2px;             
    	font: 11px sans-serif;        
    	background:white;   
    	border: 0px;      
    	border-radius: 5px;           
    	pointer-events: none;         
    }
</style>
<head>
    <title>COVID-19 Cases in the US</title>
    <!-- Load d3.v5.js -->
    <script src="https://d3js.org/d3.v5.min.js"></script>
    <script src="https://unpkg.com/topojson@3"></script>
    <script src="http://code.jquery.com/jquery-1.11.3.min.js"></script>
<link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/css/bootstrap.min.css" integrity="sha384-Gn5384xqQ1aoWXA+058RXPxPg6fy4IWvTNh0E263XmFcJlSAwiGgFAW/dAiS6JXm" crossorigin="anonymous">
</head>

<body>
<!-- Create an element where the map will take place -->

<svg id="my_dataviz">
</svg>

<div id = "page1" style = "display:none">
    <div id = "slider">
    </div>
</div>
<div id = "page2" style = "display:block">

</div>
<div id = "page3" style = "display:none">
    elements for page 3
</div>

<div>
    <div>
        <button id = "backward">Prev</button>
    </div>
    <div>
        <button id = "forward">Next</button>
    </div>
</div>

<script>

    //overall data and setting
    var usmap = d3.json("https://unpkg.com/us-atlas@1/us/10m.json");
    var data = d3.csv("../data/time_series_covid19_confirmed_US.csv");

    var margin = {top:100, right:100, bottom:100, left:100},
        width = 1080,
        height = 800;
    var svg = d3.select("#my_dataviz").attr("width", width).attr("height", height)

    //map projection
    var projection = d3.geoAlbersUsa()
        .translate([480, 300]).scale(1280)
    var path = d3.geoPath()

    // Append Div for tooltip to SVG
    var div = d3.select("body")
		    .append("div")   
            .attr("id","tool-tip")
    		.attr("class", "tooltip")               
    		.style("opacity", 0);
        p1 = div.append("p")
        p2 = div.append("p")

    //update function for year
    var startDate = new Date("01/22/2020")
    listDate = []
    for (i=0; i<185; i++){
        tmp = new Date(startDate.getTime() + i*864E5);
        listDate[i] = (tmp.getMonth()+1).toString() + "/" + tmp.getDate().toString() + "/20"
    }
    console.log(listDate)

Promise.all([usmap, data]).then(function (values) {
//read data and topojson file    
    var map = values[0];
    var covid = values[1];
    var stateFeatures = topojson.feature(map, map.objects.states).features;
    var countyFeatures = topojson.feature(map, map.objects.counties).features;

    console.log(map)
    console.log(countyFeatures)
    console.log(covid)

//settings for page 1************************************
    //slide bar location
    var slider = d3.select("#slider")
    //slide bar setting
    slider.append("input")
        .attr("type", "range")
        .attr("min", 0)
        .attr("max", 184) //col range
        .attr("step","1")
        .attr("id", "date")
        .attr("value", 184) //default value
        .on("input", function input() {
            update();
        }
        ); 

    function update(drawCircle) {
        svg.select("#circle-group").remove()
        
        var slider_col = document.getElementById("date").value;
        var curDate = listDate[slider_col]

        var circles = svg
            .append("g")
            .attr("id","circle-group")
            .selectAll("circle")
        var join = circles.data(covid)
        var enter = join.enter()
        var exit = join.exit()
        
        //console.log(join)
        //console.log(enter)

        enter.append("circle")
            .filter(function(d) {
                return (projection([d.Long_, d.Lat])!==null && d[curDate]!=0)
                })
            .attr("cx", function(d) {return projection([d.Long_, d.Lat])[0];})
            .attr("cy", function(d) {return projection([d.Long_, d.Lat])[1];})
            .attr("r", function(d) {
                //console.log(d[curDate])
                return d[curDate]/10000})
            .style("fill", "blue")
            .attr("stroke", "blue")
            .attr("stroke-width", 3)
            .attr("fill-opacity", .4)
            .on("mouseover", function(d,i){
                //tooltip
                div.transition()        
      	            .duration(200)      
                    .style("opacity", .9);      
                p1.text(d["Admin2"]+", "+d["Province_State"])
                p2.text("Total Confirmed Case: "+d[curDate])
                div.style("left", (d3.event.pageX) + "px")     
                    .style("top", (d3.event.pageY - 28) + "px");
                //console.log(div)
            })
            .on("mouseout", function(d,i){
                div.transition()
                    .duration(500)
                    .style("opacity", 0);
            })
        exit.remove();
    }   

    function drawPage1() {
        //draw map
        svg.append("g")
            .selectAll("path")
            .data(countyFeatures)
            .enter()
            .append("path")
            .attr("fill", "#ccc")
            .attr("stroke", "white")
            .attr("d",path)
            .on("mouseover", function(d,i) {
                var currentState = this;
                d3.select(this).style("fill-opacity", 0.5);
            })
            .on("mouseout", function(d,i) {
                var currentState = this;
                d3.select(this).style("fill-opacity", 1)
            })
        svg.append("g") 
            .selectAll("path")
            .data(stateFeatures)
            .enter()
            .append("path")
            .attr("stroke", "red")
            .attr("fill", "none")
            .attr("d",path)
        
        update();
    
    }

    


//************ Draw Page 2***************
    //data processing for page2
    for (i=0; i<185; i++){
        var value = listDate[i]
        
        temp = d3.nest()
        .key(function (d) {return d.Province_State;})
        .rollup(function(v) {
            return {
                cases: d3.sum(v, function(d) {return d[value]}),
                date: listDate[i],
                //name: d.Province_State
            }       
        })
        .entries(covid)
        
        temp2 = temp.map(function (d,i) {
            return{
                state: d.key,
                value: [{date: d.value.date, cases: d.value.cases}]
            }
        })

        if (i==0) {
            var tmp2 = temp2
        } else {
            for (j=0; j<tmp2.length; j++){
                tmp2[j].value.push(temp2[j].value[0])
            }
        }
    }

    console.log(tmp2)

    stateName = []
    for (i=0; i<58; i++) {
        stateName.push(tmp2[i].state)
    }
    console.log(stateName)

    var myColor = d3.scalePoint().domain(stateName).range([0,1]);

    var xPage2 = d3.scalePoint().domain(listDate).range([0, width-margin.left-margin.right])
    var yPage2 = d3.scaleLinear().domain([0,500000]).range([height-margin.bottom-margin.top, 0])
    //var yPage2 = d3.scaleLog().domain([1,500000]).range([height-margin.bottom-margin.top, 0])

    var line = d3.line()
        .x(function(d) {
            return xPage2(d.date)})
        .y(function(d) {return yPage2(d.cases)})


    function drawPage2() {
        //main part of line chart
        svg.append("g")
            .attr("transform", "translate("+margin.left+","+margin.top+")")
            .selectAll("path")
            .data(tmp2)//.slice(14,19))
            .enter()
            .append("path")
            .attr("class", function(d) {return d.state+"-line"})
            .attr("d", function(d) {
                //console.log(line(d.value))
                return line(d.value)
                })
            .attr("stroke", function(d) {return d3.interpolateRainbow(myColor(d.state))})
            .style("fill", "none")
            .style("stroke-width", 4)
            .style("opacity", 0)
        
        //add x axis
        svg.append("g")
            .attr("transform", "translate("+margin.left+","+(height - margin.bottom)+")")
            .call(d3.axisBottom(xPage2)
                    .tickValues(["2/1/20","3/1/20","4/1/20","5/1/20","6/1/20","7/1/20"]))
        //add y axis
        svg.append("g")
            .attr("transform", "translate("+margin.left+","+(margin.top)+")")
            .call(d3.axisLeft(yPage2))


        //circle and tool tip for mouseover
        for (i=0; i<58; i++) {
            var name = tmp2[i].state
            svg.append("g")
                .attr("transform", "translate("+margin.left+","+margin.top+")")
                .selectAll("circle")
                .data(tmp2[i].value)
                .enter()
                .append("circle")
                .attr("class", tmp2[i].state+"-circle")
                .attr("cx", function (d) {return xPage2(d.date)})
                .attr("cy", function (d) {return yPage2(d.cases)})
                .attr("r", 5)
                .attr("fill", function(d) {return d3.interpolateRainbow(myColor(tmp2[i].state))})
                .on("mouseover", function(d){
                    //tooltip
                    div.transition()        
      	                .duration(200)      
                        .style("opacity", .9);    
                    p1.text("Confirmed Case: "+d.cases)
                    div.style("left", (d3.event.pageX) + "px")     
                        .style("top", (d3.event.pageY - 28) + "px");
                //console.log(div)
                })
                .on("mouseout", function(d,i){
                    div.transition()
                        .duration(500)
                        .style("opacity", 0);
                })
        }
    
    svg.selectAll("circle")
        .style("opacity", 0)


    // end of draw page 2   
    }

    var button = d3.select("#page2")
        .append("div")
        .attr("class", "btn-toolbar")
        .attr("role","toolbar")
    button.append("div")
        .attr("class", "btn-group btn-group-sm")
        .selectAll("button")
        .data(tmp2.slice(0,15))
        .enter()
        .append("button")//.Puerto Rico-circle
        .on("click", function(d) {
            //console.log(d.state)
            //console.log("."+d.state+"-circle")
            var curOpacity = d3.selectAll("."+d.state+"-circle").style("opacity")
            d3.selectAll("."+d.state+"-circle").transition().style("opacity", curOpacity == 1 ? 0:1)
            d3.selectAll("."+d.state+"-line").transition().style("opacity", curOpacity == 1 ? 0:1)
            if (curOpacity==0){
                d3.select(this).attr("class", "btn btn-secondary active")
            } else {
                d3.select(this).attr("class", "btn btn-secondary")
            }
        })
        .attr("type", "button")
        .attr("class", "btn btn-secondary")
        .attr("id", function(d){
            return d.state
        })
        .text(function(d) {return d.state})
    button.append("div")
        .attr("class", "btn-group btn-group-sm")
        .selectAll("button")
        .data(tmp2.slice(15,34))
        .enter()
        .append("button")
        .on("click", function(d) {
            var curOpacity = d3.selectAll("."+d.state+"-circle").style("opacity")
            d3.selectAll("."+d.state+"-circle").transition().style("opacity", curOpacity == 1 ? 0:1)
            d3.selectAll("."+d.state+"-line").transition().style("opacity", curOpacity == 1 ? 0:1)
            if (curOpacity==0){
                d3.select(this).attr("class", "btn btn-secondary active")
            } else {
                d3.select(this).attr("class", "btn btn-secondary")
            }
        })
        .attr("type", "button")
        .attr("class", "btn btn-secondary")
        .attr("id", function(d){return d.state})
        .text(function(d) {return d.state})
    button.append("div")
        .attr("class", "btn-group btn-group-sm")
        .selectAll("button")
        .data(tmp2.slice(34,49))
        .enter()
        .append("button")
        .on("click", function(d) {
            var curOpacity = d3.selectAll("."+d.state+"-circle").style("opacity")
            d3.selectAll("."+d.state+"-circle").transition().style("opacity", curOpacity == 1 ? 0:1)
            d3.selectAll("."+d.state+"-line").transition().style("opacity", curOpacity == 1 ? 0:1)
            if (curOpacity==0){
                d3.select(this).attr("class", "btn btn-secondary active")
            } else {
                d3.select(this).attr("class", "btn btn-secondary")
            }
        })
        .attr("type", "button")
        .attr("class", "btn btn-secondary")
        .attr("id", function(d){return d.state})
        .text(function(d) {return d.state})
    button.append("div")
        .attr("class", "btn-group btn-group-sm")
        .selectAll("button")
        .data(tmp2.slice(49,58))
        .enter()
        .append("button")
        .on("click", function(d) {
            var curOpacity = d3.selectAll("."+d.state+"-circle").style("opacity")
            d3.selectAll("."+d.state+"-circle").transition().style("opacity", curOpacity == 1 ? 0:1)
            d3.selectAll("."+d.state+"-line").transition().style("opacity", curOpacity == 1 ? 0:1)
            if (curOpacity==0){
                d3.select(this).attr("class", "btn btn-secondary active")
            } else {
                d3.select(this).attr("class", "btn btn-secondary")
            }
        })
        .attr("type", "button")
        .attr("class", "btn btn-secondary")
        .attr("id", function(d){return d.state})
        .text(function(d) {return d.state})


    drawPage2();
//****************************************
    //scene change
    var counter = 2

    $("#backward").click(function (){
		counter = counter - 1;
		if(counter < 1){
			counter = 3;
		}
        //hide or show elements for different pages
        var x = document.getElementById("page1");
        var y = document.getElementById("page2");
        var z = document.getElementById("page3");
        x.style.display = "none";
        y.style.display = "none";
        z.style.display = "none";
        d3.select("#my_dataviz").selectAll("*").remove();
        switch(counter) {
            case 1: 
                x.style.display = "block";
                drawPage1();
                break;
            case 2: 
                y.style.display = "block";
                drawPage2();
                break;
            case 3: z.style.display = "block"
        }
           
		//update svg below
        console.log(counter)
		});

    

	$("#forward").click(function (){
		counter = counter + 1;
		if(counter > 3){
			counter = 1;
		}
        //hide or show elements for different pages
        var x = document.getElementById("page1");
        var y = document.getElementById("page2");
        var z = document.getElementById("page3");
        d3.select("#my_dataviz").selectAll("*").remove();
        x.style.display = "none";
        y.style.display = "none";
        z.style.display = "none" 
        switch(counter) {
            case 1: 
                x.style.display = "block";
                drawPage1();
                break;
            case 2: 
                y.style.display = "block";
                drawPage2();
                break;
            case 3: z.style.display = "block"
        }
		//update svg below
        console.log(counter)
	});


});


  
</script>
</body>